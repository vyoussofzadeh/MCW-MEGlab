% function bs_preprocess(sFiles)
% % Script generated by Brainstorm (08-Mar-2022)
%
% [path, ~] = fileparts(sFiles{1});
% ChannelMat = load(fullfile(path,'channel_vectorview306_acc1'));
%
% % Start a new report
% bst_report('Start', sFiles);
% iChannels = find(strcmpi({ChannelMat.Channel.Type}, 'ECG'));
% if length(iChannels)==1
%     % Process: Detect heartbeats
%     sFiles = bst_process('CallProcess', 'process_evt_detect_ecg', sFiles, [], ...
%         'channelname', ChannelMat.Channel(iChannels(1)).Name, ...
%         'timewindow',  [], ...
%         'eventname',   'cardiac');
% end
%
% iChannels = find(strcmpi({ChannelMat.Channel.Type}, 'EOG'));
% if length(iChannels)==2
%
%     % Process: Detect eye blinks
%     sFiles = bst_process('CallProcess', 'process_evt_detect_eog', sFiles, [], ...
%         'channelname', ChannelMat.Channel(iChannels(1)).Name, ...
%         'timewindow',  [], ...
%         'eventname',   'blink');
%
%     % Process: Detect eye blinks
%     sFiles = bst_process('CallProcess', 'process_evt_detect_eog', sFiles, [], ...
%         'channelname', ChannelMat.Channel(iChannels(2)).Name, ...
%         'timewindow',  [], ...
%         'eventname',   'blink_lat');
%
% end
%
% % Process: Remove simultaneous
% sFiles = bst_process('CallProcess', 'process_evt_remove_simult', sFiles, [], ...
%     'remove', 'cardiac', ...
%     'target', 'blink', ...
%     'dt',     0.25, ...
%     'rename', 0);
%
% % Process: Low-pass:70Hz
% sFiles = bst_process('CallProcess', 'process_bandpass', sFiles, [], ...
%     'sensortypes', '', ...
%     'highpass',    0, ...
%     'lowpass',     40, ...
%     'tranband',    0, ...
%     'attenuation', 'relax', ...  % 40dB (relaxed)
%     'ver',         '2019', ...  % 2019
%     'mirror',      0, ...
%     'read_all',    1);
%
% % Process: SSP EOG: blink
% sFiles = bst_process('CallProcess', 'process_ssp_eog', sFiles, [], ...
%     'eventname',   'blink', ...
%     'sensortypes', 'MEG Mag', ...
%     'usessp',      1, ...
%     'select',      1);
%
% % Process: SSP EOG: blink
% sFiles = bst_process('CallProcess', 'process_ssp_eog', sFiles, [], ...
%     'eventname',   'blink', ...
%     'sensortypes', 'MEG Grad', ...
%     'usessp',      1, ...
%     'select',      1);
%
% % Process: Apply SSP & CTF compensation
% bst_process('CallProcess', 'process_ssp_apply', sFiles, []);
%
% end


function bs_preprocess(sFiles)
% Script generated by Brainstorm (08-Mar-2022)

[path, ~] = fileparts(sFiles{1});
ChannelMat = load(fullfile(path,'channel_vectorview306_acc1'));

% Start a new report
bst_report('Start', sFiles);

% Process: Detect heartbeats
iChannels = find(strcmpi({ChannelMat.Channel.Type}, 'ECG'));
if length(iChannels) == 1
    sFiles = bst_process('CallProcess', 'process_evt_detect_ecg', sFiles, [], ...
        'channelname', ChannelMat.Channel(iChannels(1)).Name, ...
        'timewindow',  [], ...
        'eventname',   'cardiac');
end

% Process: Detect eye blinks
iChannels = find(strcmpi({ChannelMat.Channel.Type}, 'EOG'));
if length(iChannels) == 2
    sFiles = bst_process('CallProcess', 'process_evt_detect_eog', sFiles, [], ...
        'channelname', ChannelMat.Channel(iChannels(1)).Name, ...
        'timewindow',  [], ...
        'eventname',   'blink');
    
    sFiles = bst_process('CallProcess', 'process_evt_detect_eog', sFiles, [], ...
        'channelname', ChannelMat.Channel(iChannels(2)).Name, ...
        'timewindow',  [], ...
        'eventname',   'blink_lat');
end

% Process: Remove simultaneous
sFiles = bst_process('CallProcess', 'process_evt_remove_simult', sFiles, [], ...
    'remove', 'cardiac', ...
    'target', 'blink', ...
    'dt',     0.25, ...
    'rename', 0);

% Process: Low-pass:70Hz
sFiles = bst_process('CallProcess', 'process_bandpass', sFiles, [], ...
    'sensortypes', '', ...
    'highpass',    0.1, ...
    'lowpass',     40, ...
    'tranband',    0, ...
    'attenuation', 'relax', ...  % 40dB (relaxed)
    'ver',         '2019', ...  % 2019
    'mirror',      0, ...
    'read_all',    1);

% Process: SSP EOG: blink (MEG Mag)
sFiles = bst_process('CallProcess', 'process_ssp_eog', sFiles, [], ...
    'eventname',   'blink', ...
    'sensortypes', 'MEG Mag', ...
    'usessp',      1, ...
    'select',      1, ...
    'overwrite',   1);          % Overwrite the input files

% Process: SSP EOG: blink (MEG Grad)
sFiles = bst_process('CallProcess', 'process_ssp_eog', sFiles, [], ...
    'eventname',   'blink', ...
    'sensortypes', 'MEG Grad', ...
    'usessp',      1, ...
    'select',      1, ...
    'overwrite',   1);          % Overwrite the input files


% Process: Apply SSP & CTF compensation
bst_process('CallProcess', 'process_ssp_apply', sFiles, []);

% Save the database
% bst_save;
end

