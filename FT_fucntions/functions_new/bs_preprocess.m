function bs_preprocess(sFiles)
% Script generated by Brainstorm (08-Mar-2022)

% Input files
% sFiles = {...
%     'EC1002/@rawec1002_SD_run1_raw/data_0raw_ec1002_SD_run1_raw.mat'};

[path, ~] = fileparts(sFiles{1});
ChannelMat = load(fullfile(path,'channel_vectorview306_acc1'));

% Start a new report
bst_report('Start', sFiles);
iChannels = find(strcmpi({ChannelMat.Channel.Type}, 'ECG'));
if length(iChannels)==1
    % Process: Detect heartbeats
    sFiles = bst_process('CallProcess', 'process_evt_detect_ecg', sFiles, [], ...
        'channelname', ChannelMat.Channel(iChannels(1)).Name, ...
        'timewindow',  [], ...
        'eventname',   'cardiac');
end

iChannels = find(strcmpi({ChannelMat.Channel.Type}, 'EOG'));
if length(iChannels)==2
    
    % Process: Detect eye blinks
    sFiles = bst_process('CallProcess', 'process_evt_detect_eog', sFiles, [], ...
        'channelname', ChannelMat.Channel(iChannels(1)).Name, ...
        'timewindow',  [], ...
        'eventname',   'blink');
    
    % Process: Detect eye blinks
    sFiles = bst_process('CallProcess', 'process_evt_detect_eog', sFiles, [], ...
        'channelname', ChannelMat.Channel(iChannels(2)).Name, ...
        'timewindow',  [], ...
        'eventname',   'blink_lat');
    
end

% Process: Remove simultaneous
sFiles = bst_process('CallProcess', 'process_evt_remove_simult', sFiles, [], ...
    'remove', 'cardiac', ...
    'target', 'blink', ...
    'dt',     0.25, ...
    'rename', 0);

% Process: Low-pass:70Hz
sFiles = bst_process('CallProcess', 'process_bandpass', sFiles, [], ...
    'sensortypes', '', ...
    'highpass',    0, ...
    'lowpass',     70, ...
    'tranband',    0, ...
    'attenuation', 'relax', ...  % 40dB (relaxed)
    'ver',         '2019', ...  % 2019
    'mirror',      0, ...
    'read_all',    1);

% % Process: SSP ECG: cardiac
% sFiles = bst_process('CallProcess', 'process_ssp_ecg', sFiles, [], ...
%     'eventname',   'cardiac', ...
%     'sensortypes', 'MEG Mag', ...
%     'usessp',      1, ...
%     'select',      1);
% 
% % Process: SSP ECG: cardiac
% sFiles = bst_process('CallProcess', 'process_ssp_ecg', sFiles, [], ...
%     'eventname',   'cardiac', ...
%     'sensortypes', 'MEG Grad', ...
%     'usessp',      1, ...
%     'select',      1);

% Process: SSP EOG: blink
sFiles = bst_process('CallProcess', 'process_ssp_eog', sFiles, [], ...
    'eventname',   'blink', ...
    'sensortypes', 'MEG Mag', ...
    'usessp',      1, ...
    'select',      1);

sFiles1 = sFiles;

% Process: SSP EOG: blink
sFiles = bst_process('CallProcess', 'process_ssp_eog', sFiles, [], ...
    'eventname',   'blink', ...
    'sensortypes', 'MEG Grad', ...
    'usessp',      1, ...
    'select',      1);

% Process: Apply SSP & CTF compensation
sFiles = bst_process('CallProcess', 'process_ssp_apply', sFiles, []);

% Save and display report
% ReportFile = bst_report('Save', sFiles);
% bst_report('Open', ReportFile);
% bst_report('Export', ReportFile, ExportDir);
% bst_report('Email', ReportFile, username, to, subject, isFullReport);

end
